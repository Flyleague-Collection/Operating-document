name: Build & Deploy Docs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      docs_changed: ${{ steps.check_files.outputs.docs }}
      config_changed: ${{ steps.check_files.outputs.config }}
      should_build: ${{ steps.check_files.outputs.docs == 'true' || steps.check_files.outputs.config == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check for relevant file changes
        id: check_files
        run: |
          # å¯¹äº PRï¼Œæ¯”è¾ƒå½“å‰åˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # å¯¹äº pushï¼Œæ¯”è¾ƒå½“å‰æäº¤ä¸ä¸Šä¸€æ¬¡æäº¤
            # ä¿®å¤ï¼šä½¿ç”¨æ›´å¯é çš„æ–¹å¼è·å–å‰ä¸€ä¸ªæäº¤
            BASE_SHA=$(git log --oneline -n 2 | tail -1 | cut -d' ' -f1)
            HEAD_SHA=$(git rev-parse HEAD)
          fi
          
          echo "Comparing $BASE_SHA..$HEAD_SHA"
          
          # ä¿®å¤ï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œé¿å… grep ç©ºç»“æœæŠ¥é”™
          changed_files=$(git diff --name-only $BASE_SHA $HEAD_SHA || echo "")
          
          # æ£€æŸ¥ zensical.toml æ˜¯å¦å˜æ›´
          if echo "$changed_files" | grep -q "zensical.toml"; then
            echo "config_changed=true" >> $GITHUB_OUTPUT
          else
            echo "config_changed=false" >> $GITHUB_OUTPUT
          fi
          
          # æ£€æŸ¥ /docs/ ç›®å½•ä¸‹æ–‡ä»¶æ˜¯å¦å˜æ›´
          if echo "$changed_files" | grep -q "^docs/"; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Files changed in docs/: $(echo "$changed_files" | grep '^docs/' || echo 'none')"
          echo "zensical.toml changed: $(echo "$changed_files" | grep 'zensical.toml' || echo 'no')"

  build:
    needs: check_changes
    if: needs.check_changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    outputs:
      commit_hash: ${{ steps.build-info.outputs.commit_hash }}
      commit_hash_long: ${{ steps.build-info.outputs.commit_hash_long }}
      commit_message: ${{ steps.build-info.outputs.commit_message }}
      python_version: ${{ steps.build-info.outputs.python_version }}
      build_date: ${{ steps.build-info.outputs.build_date }}
      branch_name: ${{ steps.build-info.outputs.branch_name }}
      has_changes: ${{ needs.check_changes.outputs.should_build }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: 3.12
          cache: pip
        
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # ä¿®å¤ï¼šç¡®ä¿å®‰è£… zensical å’Œé¡¹ç›®ä¾èµ–
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # ç¡®ä¿ zensical å¯ç”¨
          pip install zensical

      - name: Get build information
        id: build-info
        run: |
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_hash_long=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B | head -n 1 | tr -d '\n')" >> $GITHUB_OUTPUT
          echo "python_version=$(python --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Build Document
        run: zensical build

      - name: Upload Site Artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: site
          retention-days: 1

  deploy_build:
    needs: [check_changes, build]
    if: needs.check_changes.outputs.should_build == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: site
          path: ./site

      - name: Check if build branch content changed
        id: check_build_changes
        run: |
          # ä¿®å¤ï¼šæ›´å¯é åœ°æ£€æŸ¥ build åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --exit-code --heads origin build; then
            echo "Build branch exists"
            git fetch origin build
            git worktree add ../build-branch build
            # æ¯”è¾ƒæ–‡ä»¶å·®å¼‚
            if diff -qr ./site ../build-branch > /dev/null 2>&1; then
              echo "no_changes=true" >> $GITHUB_OUTPUT
              echo "ğŸ“ Build branch content unchanged, skipping deployment"
            else
              echo "no_changes=false" >> $GITHUB_OUTPUT
              echo "ğŸ”„ Build branch content changed, proceeding with deployment"
            fi
            # æ¸…ç†å·¥ä½œæ ‘
            git worktree remove ../build-branch
          else
            echo "Build branch does not exist, will create it"
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to build branch
        if: steps.check_build_changes.outputs.no_changes == 'false'
        run: |
          # ä¿®å¤ï¼šä½¿ç”¨ä¸´æ—¶ç›®å½•è¿›è¡Œéƒ¨ç½²
          mkdir -p /tmp/deploy
          cd /tmp/deploy
          git init
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # æ‹‰å– build åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if git ls-remote --exit-code --heads origin build; then
            git pull origin build
          else
            git checkout --orphan build
          fi
          
          # æ¸…ç©ºå½“å‰åˆ†æ”¯å†…å®¹ï¼ˆé™¤äº† .gitï¼‰
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} + 2>/dev/null || true
          
          # å¤åˆ¶æ–°æ„å»ºçš„æ–‡ä»¶
          cp -r $GITHUB_WORKSPACE/site/* ./
          
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "Build: ${{ needs.build.outputs.commit_hash }} from ${{ needs.build.outputs.branch_name }}
          Python: ${{ needs.build.outputs.python_version }}
          Message: ${{ needs.build.outputs.commit_message }}
          Date: ${{ needs.build.outputs.build_date }}"
            git push origin build
            echo "âœ… Successfully deployed to build branch"
          else
            echo "âš ï¸ No changes to deploy"
          fi

      - name: Skip deployment (no changes)
        if: steps.check_build_changes.outputs.no_changes == 'true'
        run: echo "ğŸš« Skipping build branch deployment - no content changes detected"

  deploy_pages:
    needs: [check_changes, build]
    if: needs.check_changes.outputs.should_build == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: site
          path: ./site

      - name: Check if gh-pages content changed
        id: check_pages_changes
        run: |
          # ä¿®å¤ï¼šæ›´å¯é åœ°æ£€æŸ¥ gh-pages åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --exit-code --heads origin gh-pages; then
            echo "gh-pages branch exists"
            git fetch origin gh-pages
            git worktree add ../gh-pages-branch gh-pages
            # æ¯”è¾ƒæ–‡ä»¶å·®å¼‚ï¼ˆæ’é™¤CNAMEæ–‡ä»¶ï¼‰
            if diff -qr --exclude=CNAME ./site ../gh-pages-branch > /dev/null 2>&1; then
              echo "no_changes=true" >> $GITHUB_OUTPUT
              echo "ğŸ“ gh-pages content unchanged, skipping deployment"
            else
              echo "no_changes=false" >> $GITHUB_OUTPUT
              echo "ğŸ”„ gh-pages content changed, proceeding with deployment"
            fi
            # æ¸…ç†å·¥ä½œæ ‘
            git worktree remove ../gh-pages-branch
          else
            echo "gh-pages branch does not exist, will create it"
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to gh-pages branch
        if: steps.check_pages_changes.outputs.no_changes == 'false'
        run: |
          # ä¿®å¤ï¼šä½¿ç”¨ä¸´æ—¶ç›®å½•è¿›è¡Œéƒ¨ç½²
          mkdir -p /tmp/deploy-pages
          cd /tmp/deploy-pages
          git init
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # æ‹‰å– gh-pages åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if git ls-remote --exit-code --heads origin gh-pages; then
            git pull origin gh-pages
          else
            git checkout --orphan gh-pages
          fi
          
          # æ¸…ç©ºå½“å‰åˆ†æ”¯å†…å®¹ï¼ˆé™¤äº† .gitï¼‰
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} + 2>/dev/null || true
          
          # å¤åˆ¶æ–°æ„å»ºçš„æ–‡ä»¶
          cp -r $GITHUB_WORKSPACE/site/* ./
          
          # æ·»åŠ  CNAME æ–‡ä»¶ï¼ˆå¦‚æœåŸŸåé…ç½®éœ€è¦ï¼‰
          echo "docs.master-gui.cn" > CNAME
          
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "gh-pages: ${{ needs.build.outputs.commit_hash }} from ${{ needs.build.outputs.branch_name }}
            Python: ${{ needs.build.outputs.python_version }}
            Message: ${{ needs.build.outputs.commit_message }}
            Date: ${{ needs.build.outputs.build_date }}"
            git push origin gh-pages
            echo "âœ… Successfully deployed to gh-pages branch"
          else
            echo "âš ï¸ No changes to deploy"
          fi

      - name: Skip deployment (no changes)
        if: steps.check_pages_changes.outputs.no_changes == 'true'
        run: echo "ğŸš« Skipping gh-pages deployment - no content changes detected"