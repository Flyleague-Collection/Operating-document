name: Build & Deploy Docs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      docs_changed: ${{ steps.check_files.outputs.docs }}
      config_changed: ${{ steps.check_files.outputs.config }}
      should_build: ${{ steps.check_files.outputs.docs == 'true' || steps.check_files.outputs.config == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # èŽ·å–æœ€è¿‘2æ¬¡æäº¤ç”¨äºŽæ¯”è¾ƒ
      
      - name: Check for relevant file changes
        id: check_files
        run: |
          # å¯¹äºŽ PRï¼Œæ¯”è¾ƒå½“å‰åˆ†æ”¯ä¸Žç›®æ ‡åˆ†æ”¯
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # å¯¹äºŽ pushï¼Œæ¯”è¾ƒå½“å‰æäº¤ä¸Žä¸Šä¸€æ¬¡æäº¤
            BASE_SHA=$(git rev-parse HEAD~1)
            HEAD_SHA=$(git rev-parse HEAD)
          fi
          
          echo "Comparing $BASE_SHA..$HEAD_SHA"
          
          # æ£€æŸ¥ zensical.toml æ˜¯å¦å˜æ›´
          if git diff --name-only $BASE_SHA $HEAD_SHA | grep -q "zensical.toml"; then
            echo "config_changed=true" >> $GITHUB_OUTPUT
          else
            echo "config_changed=false" >> $GITHUB_OUTPUT
          fi
          
          # æ£€æŸ¥ /docs/ ç›®å½•ä¸‹æ–‡ä»¶æ˜¯å¦å˜æ›´
          if git diff --name-only $BASE_SHA $HEAD_SHA | grep -q "^docs/"; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Files changed in docs/: $(git diff --name-only $BASE_SHA $HEAD_SHA | grep '^docs/' || echo 'none')"
          echo "zensical.toml changed: $(git diff --name-only $BASE_SHA $HEAD_SHA | grep 'zensical.toml' || echo 'no')"

  build:
    needs: check_changes
    if: needs.check_changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    outputs:
      commit_hash: ${{ steps.build-info.outputs.commit_hash }}
      commit_hash_long: ${{ steps.build-info.outputs.commit_hash_long }}
      commit_message: ${{ steps.build-info.outputs.commit_message }}
      python_version: ${{ steps.build-info.outputs.python_version }}
      build_date: ${{ steps.build-info.outputs.build_date }}
      branch_name: ${{ steps.build-info.outputs.branch_name }}
      has_changes: ${{ needs.check_changes.outputs.should_build }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: 3.12
          cache: pip
        
      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Get build information
        id: build-info
        run: |
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_hash_long=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B | head -n 1)" >> $GITHUB_OUTPUT
          echo "python_version=$(python --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Build Document
        run: zensical build

      - name: Upload Site Artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: site

  deploy_build:
    needs: [check_changes, build]
    if: needs.check_changes.outputs.should_build == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: site
          path: site

      - name: Check if build branch content changed
        id: check_build_changes
        run: |
          # èŽ·å–å½“å‰æž„å»ºå†…å®¹ä¸Žbuildåˆ†æ”¯å†…å®¹çš„å·®å¼‚
          git fetch origin build
          git checkout build
          # ä¸´æ—¶ä¿å­˜å½“å‰æž„å»ºå†…å®¹ç”¨äºŽæ¯”è¾ƒ
          mkdir -p /tmp/current_site
          cp -r ../site/. /tmp/current_site/
          
          # æ¯”è¾ƒæ–‡ä»¶å·®å¼‚
          if diff -qr /tmp/current_site . > /dev/null 2>&1; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Build branch content unchanged, skipping deployment"
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Build branch content changed, proceeding with deployment"
          fi
          git checkout main

      - name: Deploy to build branch
        if: steps.check_build_changes.outputs.no_changes == 'false'
        run: |
          git init
          git checkout --orphan build
          cp -r site/. .
          git add .
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git commit -m "Build: ${{ needs.build.outputs.commit_hash }} from ${{ needs.build.outputs.branch_name }}
          Python: ${{ needs.build.outputs.python_version }}
          Message: ${{ needs.build.outputs.commit_message }}
          Date: ${{ needs.build.outputs.build_date }}"

          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin build --force

      - name: Skip deployment (no changes)
        if: steps.check_build_changes.outputs.no_changes == 'true'
        run: echo "ðŸš« Skipping build branch deployment - no content changes detected"

  deploy_pages:
    needs: [check_changes, build]
    if: needs.check_changes.outputs.should_build == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: site
          path: site

      - name: Check if gh-pages content changed
        id: check_pages_changes
        run: |
          git fetch origin gh-pages
          git checkout gh-pages
          # ä¸´æ—¶ä¿å­˜å½“å‰æž„å»ºå†…å®¹ç”¨äºŽæ¯”è¾ƒ
          mkdir -p /tmp/current_site
          cp -r ../site/. /tmp/current_site/
          
          # æ¯”è¾ƒæ–‡ä»¶å·®å¼‚ï¼ˆæŽ’é™¤CNAMEæ–‡ä»¶ï¼‰
          if diff -qr --exclude=CNAME /tmp/current_site . > /dev/null 2>&1; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ gh-pages content unchanged, skipping deployment"
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ”„ gh-pages content changed, proceeding with deployment"
          fi
          git checkout main

      - name: Deploy to gh-pages branch
        if: steps.check_pages_changes.outputs.no_changes == 'false'
        run: |
          git init
          git checkout --orphan gh-pages
          cp -r site/. .
          echo "docs.master-gui.cn" > CNAME
          
          git add .
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git commit -m "gh-pages: ${{ needs.build.outputs.commit_hash }} from ${{ needs.build.outputs.branch_name }}
          Python: ${{ needs.build.outputs.python_version }}
          Message: ${{ needs.build.outputs.commit_message }}
          Date: ${{ needs.build.outputs.build_date }}"

          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin gh-pages --force

      - name: Skip deployment (no changes)
        if: steps.check_pages_changes.outputs.no_changes == 'true'
        run: echo "ðŸš« Skipping gh-pages deployment - no content changes detected"