name: Release Management

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"  # æ¯æ—¥ 12:00 UTCï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´ 20:00ï¼‰

permissions:
  contents: write

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get latest semantic tag
        id: get_tag
        shell: bash
        run: |
          # è·å–æ‰€æœ‰è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾å¹¶æ’åº
          LATEST_TAG=$(git tag --list "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          if [ -z "$LATEST_TAG" ]; then
            echo "first_commit=true" >> $GITHUB_OUTPUT
            echo "No semantic tag found; starting from v1.0.0"
          else
            echo "first_commit=false" >> $GITHUB_OUTPUT
            echo "Latest tag: $LATEST_TAG"
          fi

      - name: Compute next version
        id: version
        shell: bash
        run: |
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            NEXT_TAG="v1.0.0"
          else
            BASE=${{ steps.get_tag.outputs.latest_tag }}
            BASE=${BASE#v}
            MAJOR=$(echo $BASE | cut -d. -f1)
            MINOR=$(echo $BASE | cut -d. -f2)
            PATCH=$(echo $BASE | cut -d. -f3)
            NEXT_PATCH=$((PATCH + 1))
            NEXT_TAG="v${MAJOR}.${MINOR}.${NEXT_PATCH}"
          fi
          echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT
          echo "Next tag: $NEXT_TAG"

      - name: Debug - Show git history
        shell: bash
        run: |
          echo "=== å®Œæ•´çš„ git log ==="
          git log --oneline -10
          echo "=== æ ‡ç­¾åˆ—è¡¨ ==="
          git tag -l --sort=-v:refname | head -10
          echo "=== å½“å‰åˆ†æ”¯ ==="
          git branch -a

      - name: Collect commit information
        id: collect_commits
        shell: bash
        run: |
          echo "ğŸ“ Collecting commit information between tags..."
          
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            # é¦–æ¬¡å‘å¸ƒï¼Œè·å–æ‰€æœ‰æäº¤
            RANGE="$(git rev-list --max-parents=0 HEAD)"
            echo "First release, getting all commits from initial commit"
          else
            # æ­£å¸¸å‘å¸ƒï¼Œè·å–ä»ä¸Šä¸ªæ ‡ç­¾åˆ°å½“å‰HEADçš„æäº¤
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${{ steps.get_tag.outputs.latest_tag }}"^ 2>/dev/null || echo "")
            if [ -z "$PREVIOUS_TAG" ]; then
              RANGE="${{ steps.get_tag.outputs.latest_tag }}..HEAD"
              echo "No previous tag found, using range: $RANGE"
            else
              RANGE="$PREVIOUS_TAG..HEAD"
              echo "Using range: $RANGE (from $PREVIOUS_TAG to HEAD)"
            fi
          fi
          
          # è·å–æäº¤æ•°é‡
          COMMIT_COUNT=$(git rev-list --count $RANGE 2>/dev/null || echo "0")
          echo "Commit count: $COMMIT_COUNT"
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          # è·å–è¯¦ç»†çš„æäº¤ä¿¡æ¯
          if [ "$COMMIT_COUNT" -gt 0 ]; then
            git log $RANGE --pretty=format:'%h: %s (%an, %ad)' --date=short > commits.txt
            echo "âœ… Collected $COMMIT_COUNT commits"
          else
            echo "No new commits found in range: $RANGE" > commits.txt
            echo "âš ï¸ No commits found in the specified range"
          fi
          
          # æ˜¾ç¤ºéƒ¨åˆ†æäº¤ç”¨äºè°ƒè¯•
          echo "=== Recent commits ==="
          cat commits.txt | head -20

      - name: Get contributors
        id: contrib
        shell: bash
        run: |
          echo "ğŸ‘¥ Collecting contributor information..."
          
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
          else
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${{ steps.get_tag.outputs.latest_tag }}"^ 2>/dev/null || echo "${{ steps.get_tag.outputs.latest_tag }}")
            RANGE="$PREVIOUS_TAG..HEAD"
          fi
          
          CONTRIB=$(git log $RANGE --pretty=format:'%an' 2>/dev/null | sort | uniq | grep -v '\[bot\]' | grep -v '^$' || true)
          if [ -z "$CONTRIB" ]; then
            CONTRIB="æ— "
          else
            CONTRIB=$(echo "$CONTRIB" | paste -sd ", " -)
          fi
          echo "contributors=$CONTRIB" >> $GITHUB_OUTPUT
          echo "Contributors: $CONTRIB"

      - name: Checkout build branch for artifacts
        uses: actions/checkout@v4
        with:
          ref: build
          fetch-depth: 0

      - name: Generate build artifacts
        shell: bash
        run: |
          echo "ğŸ“¦ Generating build artifacts from build branch"
          
          # æ¸…ç†å¹¶åˆ›å»ºæ„å»ºç›®å½•
          rm -rf build-output
          mkdir -p build-output
          
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°æ„å»ºè¾“å‡ºç›®å½•ï¼ˆæ’é™¤build-outputè‡ªèº«ï¼‰
          find . -maxdepth 1 -mindepth 1 -not -name build-output -not -name .git -exec cp -r {} build-output/ \;
          
          # åˆ›å»ºæ„å»ºäº§ç‰©zipæ–‡ä»¶
          zip -r build-artifacts.zip build-output/
          
          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶ä¿¡æ¯
          echo "Generated build-artifacts.zip:"
          ls -lh build-artifacts.zip
          echo "âœ… Build artifacts generated successfully"

      - name: Generate comprehensive release notes
        id: notes
        shell: bash
        run: |
          echo "ğŸ“„ Generating comprehensive release notes..."
          NEXT_TAG=${{ steps.version.outputs.next_tag }}
          LATEST_TAG=${{ steps.get_tag.outputs.latest_tag }}
          COMMIT_COUNT=${{ steps.collect_commits.outputs.commit_count }}
          
          cat << EOF > release_notes.md
          # Operating Document $NEXT_TAG
          
          ## å‘å¸ƒä¿¡æ¯
          - **ç‰ˆæœ¬å·**: $NEXT_TAG
          - **ä¸Šä¸€ä¸ªç‰ˆæœ¬**: ${LATEST_TAG:-æ— }
          - **æäº¤æ•°é‡**: $COMMIT_COUNT
          - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## å˜æ›´å†…å®¹
          
          EOF
          
          # æ·»åŠ æäº¤è®°å½•
          if [ -f commits.txt ] && [ "$COMMIT_COUNT" -gt 0 ]; then
            cat commits.txt >> release_notes.md
          else
            echo "æ— æ–°å¢æäº¤" >> release_notes.md
          fi
          
          cat << EOF >> release_notes.md
          
          ## è´¡çŒ®è€…
          ${{ steps.contrib.outputs.contributors }}
          
          ## æ„å»ºä¿¡æ¯
          - å·¥ä½œæµ: \${{ github.workflow }}
          - è¿è¡ŒID: \${{ github.run_id }}
          - è§¦å‘æ–¹å¼: \${{ github.event_name }}
          
          EOF
          
          echo "Generated release notes:"
          cat release_notes.md

      - name: Create Git Tag
        if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'true') }}
        shell: bash
        run: |
          echo "ğŸ·ï¸ Creating Git tag: ${{ steps.version.outputs.next_tag }}"
          git tag ${{ steps.version.outputs.next_tag }}
          git push origin ${{ steps.version.outputs.next_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'true') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.next_tag }}
          name: Operating Document ${{ steps.version.outputs.next_tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            build-artifacts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip Release (No changes)
        if: ${{ github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'false' }}
        shell: bash
        run: |
          echo "ğŸš« æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "å½“å‰æœ€æ–°ç‰ˆæœ¬: ${{ steps.get_tag.outputs.latest_tag }}"
          echo "æ²¡æœ‰æ–°çš„æäº¤éœ€è¦å‘å¸ƒ"

      - name: Cleanup
        if: always()
        shell: bash
        run: |
          echo "ğŸ§¹ Cleaning up temporary files..."
          rm -f commits.txt release_notes.md build-artifacts.zip
          rm -rf build-output
          echo "âœ… Cleanup completed"