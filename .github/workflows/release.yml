name: Auto Release

permissions:
  contents: write

on:
  schedule:
    # æ¯å¤© 04:00 UTC â†’ CST 12:00
    - cron: "0 4 * * *"
  workflow_dispatch:

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # åˆ¤æ–­æ˜¯å¦åº”å‘å¸ƒï¼ˆå‘¨æœ«å§‹ç»ˆå‘å¸ƒï¼Œå‘¨ä¸­æ£€æµ‹æ˜¯å¦æœ‰æäº¤ï¼‰
      - name: Check if release should run
        id: check_release
        run: |
          DAY=$(date +%u) # 1=Mon ... 7=Sun

          echo "Today weekday number: $DAY"

          # å‘¨æœ«ï¼ˆ6=Sat, 7=Sunï¼‰â†’ å¿…å‘å¸ƒ
          if [ "$DAY" -ge 6 ]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # å‘¨ä¸­ â†’ æ£€æŸ¥è¿‡å»24å°æ—¶ main æ˜¯å¦æœ‰æäº¤
          COMMITS=$(git log --since="24 å°æ—¶ä¹‹å‰" origin/main --oneline)
          if [ -z "$COMMITS" ]; then
            echo "No commits in last 24h on weekday â€” skipping release."
            echo "is_release=false" >> $GITHUB_OUTPUT
          else
            echo "Commits detected in last 24h â€” release will run."
            echo "is_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no release today
        if: steps.check_release.outputs.is_release == 'false'
        run: |
          echo "Skipping release."
          exit 0

      # è·å–æœ€æ–° tag
      - name: Get latest tag
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT

      # è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å· patch+1
      - name: Calculate next version
        id: next_version
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          version="${latest#v}"
          IFS='.' read -r major minor patch <<< "$version"
          patch=$((patch + 1))
          next="v$major.$minor.$patch"
          echo "next_version=$next" >> $GITHUB_OUTPUT

      # ç”Ÿæˆ Release Notes
      - name: Generate enterprise Release Notes
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          commits=$(git log $latest..HEAD --pretty=format:'%h|%an|%s' || echo "")
          authors=$(echo "$commits" | cut -d'|' -f2 | sort | uniq)
          total_commits=$(echo "$commits" | wc -l)

          feats=$(echo "$commits" | grep -i 'feat:' || true)
          fixes=$(echo "$commits" | grep -i 'fix:' || true)
          docs=$(echo "$commits" | grep -i 'docs:' || true)
          others=$(echo "$commits" | grep -v -E 'feat:|fix:|docs:' || true)

          date=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M CST")

          {
            echo "## ğŸš€ Release ${{ steps.next_version.outputs.next_version }} ($date)"
            echo ""
            echo "å…± **$total_commits** æ¬¡æäº¤ï¼Œ**$(echo "$authors" | wc -l)** ä½è´¡çŒ®è€…"
            echo ""
            echo "### âœ¨ æ–°åŠŸèƒ½ (feat)"
            echo "$feats"
            echo ""
            echo "### ğŸ ä¿®å¤ (fix)"
            echo "$fixes"
            echo ""
            echo "### ğŸ“š æ–‡æ¡£ (docs)"
            echo "$docs"
            echo ""
            echo "### ğŸ”§ å…¶ä»–"
            echo "$others"
            echo ""
            echo "ğŸ‘¥ è´¡çŒ®è€…ï¼š"
            echo "$authors"
          } > release_notes.md

      # æ›´æ–° CHANGELOG.md
      - name: Update CHANGELOG.md
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "# CHANGELOG" > CHANGELOG.md
          fi
          echo "" >> CHANGELOG.md
          cat release_notes.md >> CHANGELOG.md
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for ${{ steps.next_version.outputs.next_version }}" || echo "No changes to commit"
          git push origin HEAD:main

      # åˆ‡æ¢åˆ° build åˆ†æ”¯
      - name: Checkout build branch
        run: |
          git fetch origin build
          git checkout build

      # æ‰“åŒ… build äº§ç‰©
      - name: Zip build artifacts
        run: zip -r build-artifacts.zip ./*

      # å‘å¸ƒ Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.next_version.outputs.next_version }}
          name: "Release ${{ steps.next_version.outputs.next_version }}"
          body_path: release_notes.md
          files: build-artifacts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
