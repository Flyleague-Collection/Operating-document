name: Release Management

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"  # æ¯æ—¥â€¯12:00â€¯UTCï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´â€¯20:00ï¼‰

permissions:
  contents: write

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch latest tags and history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get latest semantic tag
        id: get_tag
        shell: bash
        run: |
          LATEST_TAG=$(git tag --list "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          if [ -z "$LATEST_TAG" ]; then
            echo "first_commit=true" >> $GITHUB_OUTPUT
            echo "No semantic tag found; starting from v1.0.0"
          else
            echo "first_commit=false" >> $GITHUB_OUTPUT
            echo "Latest tag: $LATEST_TAG"
          fi

      - name: Compute next version
        id: version
        shell: bash
        run: |
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            NEXT_TAG="v1.0.0"
          else
            BASE=${{ steps.get_tag.outputs.latest_tag }}
            BASE=${BASE#v}
            MAJOR=$(echo $BASE | cut -d. -f1)
            MINOR=$(echo $BASE | cut -d. -f2)
            PATCH=$(echo $BASE | cut -d. -f3)
            NEXT_PATCH=$((PATCH + 1))
            NEXT_TAG="v${MAJOR}.${MINOR}.${NEXT_PATCH}"
          fi
          echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT
          echo "Next tag: $NEXT_TAG"

      - name: Detect changes for scheduled runs
        id: check_diff
        if: ${{ github.event_name == 'schedule' }}
        shell: bash
        run: |
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          CHANGES=$(git diff --name-only ${{ steps.get_tag.outputs.latest_tag }} HEAD | wc -l)
          echo "Changed files: $CHANGES"
          if [ $CHANGES -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout build branch for artifacts
        uses: actions/checkout@v4
        with:
          ref: build
          fetch-depth: 0
          # Note: this will override the workspace with build branch content

      - name: Generate build artifacts from build branch
        shell: bash
        run: |
          echo "ğŸ“¦ Generating buildâ€‘artifacts.zip from build branch"
          mkdir -p build-output
          shopt -s extglob
          cp -r !(build-output) build-output/
          zip -r buildâ€‘artifacts.zip build-output/

      - name: Collect commit info
        id: collect
        shell: bash
        run: |
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
          else
            RANGE="${{ steps.get_tag.outputs.latest_tag }}..HEAD"
          fi
          # å¯¼å‡ºæœ¬æ¬¡å‘å¸ƒçš„commitä¿¡æ¯
          git log $RANGE --pretty=format:'%h: %s (%an)' > commits.txt
          COMMIT_COUNT=$(wc -l < commits.txt)
          echo "count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

      - name: Get contributors (filter bot, safe)
        id: contrib
        shell: bash
        run: |
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
          else
            RANGE="${{ steps.get_tag.outputs.latest_tag }}..HEAD"
          fi
          CONTRIB=$(git log $RANGE --pretty=format:'%an' 2>/dev/null | sort | uniq | grep -v '\[bot\]')
          if [ -z "$CONTRIB" ]; then
            CONTRIB="æ— "
          else
            CONTRIB=$(echo "$CONTRIB" | paste -sd ", " -)
          fi
          echo "contributors=$CONTRIB" >> $GITHUB_OUTPUT
          
      - name: Generate release notes
        id: notes
        shell: bash
        run: |
          NEXT_TAG=${{ steps.version.outputs.next_tag }}
          SHORT_VER=${NEXT_TAG#v}
          echo "è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬: ${NEXT_TAG}" > release_notes.md
          echo "å˜æ›´å†…å®¹:" >> release_notes.md
          echo "" >> release_notes.md
          cat commits.txt >> release_notes.md
          echo "" >> release_notes.md
          echo "è´¡çŒ®è€…" >> release_notes.md
          echo "${{ steps.contrib.outputs.contributors }}" >> release_notes.md
          echo "" >> release_notes.md
          echo "Generated release notes:"
          cat release_notes.md

      - name: Create Manual Release
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.next_tag }}
          name: Operatingâ€‘document ${{ steps.version.outputs.next_tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            buildâ€‘artifacts.zip

      - name: Create Auto Release
        if: ${{ github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.next_tag }}
          name: Operatingâ€‘document ${{ steps.version.outputs.next_tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            buildâ€‘artifacts.zip

      - name: Skip Release (No changes)
        if: ${{ github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'false' }}
        shell: bash
        run: |
          echo "ğŸš« æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œè·³è¿‡å‘å¸ƒ"
