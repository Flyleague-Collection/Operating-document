name: Auto Release

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    # 每天 16:00 UTC = 中国 CST 次日 00:00（午夜）
    - cron: "0 16 * * *"
  workflow_dispatch:

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 判断是否需要发布
      - name: Check if release should run
        id: check_release
        run: |
          DAY=$(date -u +%u) # 1=Mon ... 7=Sun (UTC weekday)
          echo "Today weekday: $DAY"

          # 周末（6=Sat, 7=Sun）→ 必发布
          if [ "$DAY" -ge 6 ]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 获取昨日日期（UTC时间）
          YESTERDAY=$(date -u -d "yesterday" +%Y-%m-%d)
          echo "Checking commits for yesterday: $YESTERDAY"

          # 周中检查昨日是否有提交
          COMMITS=$(git log origin/main --since="$YESTERDAY 00:00:00" --until="$YESTERDAY 23:59:59" --oneline)
          if [ -z "$COMMITS" ]; then
            echo "No commits yesterday — skip."
            echo "is_release=false" >> $GITHUB_OUTPUT
          else
            echo "Commits detected yesterday — release will run."
            echo "is_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no release today
        if: steps.check_release.outputs.is_release == 'false'
        run: exit 0

      # 获取最新 tag
      - name: Get latest tag
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT

      # 自动递增版本号：patch +1
      - name: Calculate next version
        id: next_version
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          version="${latest#v}"
          IFS='.' read -r major minor patch <<< "$version"
          next="v$major.$minor.$((patch + 1))"
          echo "next_version=$next" >> $GITHUB_OUTPUT
          echo "Next version: $next"

      # 生成 Release Notes
      - name: Generate Release Notes
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          commits=$(git log $latest..HEAD --pretty=format:'%h|%an|%s' || true)
          authors=$(echo "$commits" | cut -d'|' -f2 | sort -u)
          total_commits=$(echo "$commits" | wc -l)

          feats=$(echo "$commits" | grep -i '^.*feat' || true)
          fixes=$(echo "$commits" | grep -i '^.*fix' || true)
          docs=$(
