      # 导出 build 分支且只包含其文件，防止 workflow 污染
	  
      - name: Prepare build branch for release artifacts
        run: |
          rm -rf build_files
          git fetch origin build
          git checkout build
          # 导出 build 分支全部文件到 build_files
          git ls-tree -z -r build --name-only | xargs -0 -I{} cp --parents {} build_files/
          git checkout main

      - name: Create zipped artifact and record hash/size
        run: |
          cd build_files
          zip -r ../build-artifacts.zip ./*
          cd ..
          sha256=$(sha256sum build-artifacts.zip | awk '{print $1}')
          size_bytes=$(stat --format="%s" build-artifacts.zip)
          if [ $size_bytes -gt 1048576 ]; then
            size_str="$(echo "scale=1; $size_bytes/1048576" | bc) MB"
          else
            size_str="$size_bytes bytes"
          fi
          echo "$sha256" > build-artifacts.sha256
          echo "$size_str" > build-artifacts.size
          date -u > build-artifacts.date

      - name: Advanced release note formatting and empty artifact checks
        id: generate_body
        run: |
          last_tag="${{ steps.latest_tag.outputs.value }}"
          version="${{ steps.next_version.outputs.value }}"
          n_commit=$(git log "$last_tag"..HEAD --pretty=format:"%h" | wc -l)
          n_contrib=$(git log "$last_tag"..HEAD --pretty=format:"%an" | sort | uniq | wc -l)
          body="${version} 最新发行版\n\n本次更新共 ${n_commit} 个 commit，${n_contrib} 位贡献者。\n\n---\n"
          # ... 分组 commit 分类 shell 如你现有 …
          body+="\n---\n"
          body+="### 贡献者\n"
          git log "$last_tag"..HEAD --pretty=format:"%an" | sort | uniq | awk '{print "- " $0}' >> contributors.txt
          body+="$(cat contributors.txt)\n"
          body+="\n---\n"
          # 附件格式优化
          size=$(cat build-artifacts.size)
          hash=$(cat build-artifacts.sha256)
          date=$(cat build-artifacts.date)
          body+="### 附件资源包\n"
          if [ ! -s build-artifacts.zip ] || [ "$size" = "0 bytes" ]; then
            body+="未检测到 build 分支内容或打包文件为空（请检查build分支是否有实际内容）\n"
          else
            body+="**build-artifacts.zip**\n"
            body+="sha256: \`${hash}\`\n"
            body+="大小: ${size}\n"
            body+="打包时间: ${date}\n"
            body+="> 校验文件完整性建议：下载后可用 sha256 值校验\n"
          fi
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$body" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create & Publish Release With Artifact
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.next_version.outputs.value }}
          name: "Operating-document ${{ steps.next_version.outputs.value }} 最新发行版"
          body: ${{ steps.generate_body.outputs.body }}
          artifacts: build-artifacts.zip
          draft: false
          prerelease: false
