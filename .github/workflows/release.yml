name: Auto Release

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œæ¨é€ CHANGELOG

on:
  schedule:
    - cron: "0 12 * * 1"  # æ¯å‘¨ä¸€ 12:00 UTC
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è·å–æœ€æ–° tag
      - name: Get latest tag
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT

      # 3. è®¡ç®—ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆpatch +1ï¼‰
      - name: Calculate next version
        id: next_version
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          version="${latest#v}"
          IFS='.' read -r major minor patch <<< "$version"
          patch=$((patch + 1))
          next="v$major.$minor.$patch"
          echo "next_version=$next" >> $GITHUB_OUTPUT

      # 4. ç”Ÿæˆä¼ä¸šçº§ Release Notes å¹¶ç»Ÿè®¡è´¡çŒ®è€…
      - name: Generate enterprise Release Notes
        id: release_notes
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          # è·å–æ‰€æœ‰ commit
          commits=$(git log $latest..HEAD --pretty=format:'%h|%an|%s' || echo "")
          # æå–ä½œè€…
          authors=$(echo "$commits" | cut -d'|' -f2 | sort | uniq)
          total_commits=$(echo "$commits" | wc -l)
          
          # åˆ†ç»„
          feats=$(echo "$commits" | grep -i '^.*feat:' || true)
          fixes=$(echo "$commits" | grep -i '^.*fix:' || true)
          docs=$(echo "$commits" | grep -i '^.*docs:' || true)
          others=$(echo "$commits" | grep -v -E 'feat:|fix:|docs:' || true)

          date=$(date -u +"%Y-%m-%d")
          
          cat <<EOF > release_notes.md
## æœ¬æ¬¡æ›´æ–° ${{ steps.next_version.outputs.next_version }} ($date)

å…± $total_commits æ¬¡æäº¤ï¼Œ$(echo "$authors" | wc -l) ä½è´¡çŒ®è€…

### âœ¨ æ–°åŠŸèƒ½ (feat)
$feats

### ğŸ ä¿®å¤ (fix)
$fixes

### ğŸ“š æ–‡æ¡£ (docs)
$docs

### ğŸ”§ å…¶ä»–
$others

è´¡çŒ®è€…ï¼š
$authors
EOF

      # 5. æ›´æ–° CHANGELOG.md
      - name: Update CHANGELOG.md
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "# CHANGELOG" > CHANGELOG.md
          fi
          echo "" >> CHANGELOG.md
          cat release_notes.md >> CHANGELOG.md
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for ${{ steps.next_version.outputs.next_version }}" || echo "No changes to commit"
          git push origin HEAD:main

      # 6. Checkout build åˆ†æ”¯
      - name: Checkout build branch
        run: |
          git fetch origin build
          git checkout build

      # 7. æ‰“åŒ… build å†…å®¹
      - name: Zip build artifacts
        run: |
          zip -r build-artifacts.zip ./*

      # 8. åˆ›å»º Release å¹¶ä¸Šä¼  ZIP
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.next_version.outputs.next_version }}
          name: "Release ${{ steps.next_version.outputs.next_version }}"
          body_path: release_notes.md
          files: build-artifacts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
