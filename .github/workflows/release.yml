name: Auto Release

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´12:00è¿è¡Œï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´20:00ï¼‰
    - cron: '0 12 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      skip_check:
        description: 'è·³è¿‡å˜æ›´æ£€æµ‹ç›´æ¥å‘å¸ƒ'
        required: false
        default: false
        type: boolean

env:
  BUILD_BRANCH: 'build'  # è®¾ç½®æ„å»ºåˆ†æ”¯

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check-changes.outputs.has_changes }}
      next_tag: ${{ steps.get-next-tag.outputs.next_tag }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ env.BUILD_BRANCH }}
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•

    - name: Get next tag version
      id: get-next-tag
      run: |
        # è·å–æœ€æ–°çš„v1.0.xæ ‡ç­¾
        LATEST_TAG=$(git tag -l "v1.0.*" --sort=-v:refname | head -n 1 || echo "")
        if [ -z "$LATEST_TAG" ]; then
          NEXT_TAG="v1.0.0"
        else
          # é€’å¢ç‰ˆæœ¬å·
          BASE_VERSION=$(echo $LATEST_TAG | cut -d. -f1-2)
          PATCH_VERSION=$(echo $LATEST_TAG | awk -F. '{print $3}')
          NEXT_PATCH=$((PATCH_VERSION + 1))
          NEXT_TAG="${BASE_VERSION}.${NEXT_PATCH}"
        fi
        echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT
        echo "Next tag: $NEXT_TAG"

    - name: Check for changes and set release flag
      id: check-changes
      run: |
        # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©è·³è¿‡æ£€æµ‹ï¼Œåˆ™ç›´æ¥è®¾ç½®has_changesä¸ºtrue
        if ${{ github.event_name == 'workflow_dispatch' && inputs.skip_check }}; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Manual trigger with skip check, forcing release"
        else
          # å¦åˆ™ï¼Œæ£€æŸ¥è‡ªä¸Šä¸€ä¸ªæ ‡ç­¾ä»¥æ¥çš„å˜æ›´
          LATEST_TAG=$(git tag -l "v1.0.*" --sort=-v:refname | head -n 1 || echo "")
          if [ -z "$LATEST_TAG" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "No existing tags, proceeding with release"
          else
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
            CHANGES=$(git diff --name-only $LATEST_TAG HEAD)
            if [ -n "$CHANGES" ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "Changes detected since $LATEST_TAG"
              echo "Changes: $CHANGES"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No changes detected since $LATEST_TAG"
            fi
          fi
        fi

  create-release:
    needs: check-changes
    # ä¿®å¤æ¡ä»¶åˆ¤æ–­ï¼Œç¡®ä¿æœ‰å˜æ›´æ—¶æ‰è¿è¡Œ
    if: ${{ needs.check-changes.outputs.has_changes == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Debug outputs
      run: |
        echo "Has changes: ${{ needs.check-changes.outputs.has_changes }}"
        echo "Next tag: ${{ needs.check-changes.outputs.next_tag }}"

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ env.BUILD_BRANCH }}
        fetch-depth: 0

    - name: Get commit history
      id: get-history
      run: |
        NEXT_TAG="${{ needs.check-changes.outputs.next_tag }}"
        LATEST_TAG=$(git tag -l "v1.0.*" --sort=-v:refname | head -n 1 || echo "")
        
        echo "Latest tag: $LATEST_TAG"
        echo "Next tag: $NEXT_TAG"
        
        # è·å–æäº¤å†å²
        if [ -z "$LATEST_TAG" ]; then
          COMMIT_RANGE="HEAD"
          echo "No previous tag, using all commits"
        else
          COMMIT_RANGE="$LATEST_TAG..HEAD"
          echo "Commit range: $COMMIT_RANGE"
        fi
        
        # ç”Ÿæˆå˜æ›´å†…å®¹
        echo "å˜æ›´å†…å®¹:" > commit_history.txt
        git log $COMMIT_RANGE --pretty=format:"%h: %s" >> commit_history.txt
        
        # è·å–å»é‡åçš„è´¡çŒ®è€…åˆ—è¡¨
        echo "è´¡çŒ®è€…ï¼š" > contributors.txt
        git log $COMMIT_RANGE --pretty=format:"%an" | sort -u | awk '{print "- " $0}' >> contributors.txt
        
        # æ˜¾ç¤ºæäº¤å†å²ç”¨äºè°ƒè¯•
        echo "Commit history:"
        cat commit_history.txt
        echo "Contributors:"
        cat contributors.txt

    - name: Create package
      run: |
        # åˆ›å»ºæ—¶é—´æˆ³ç”¨äºæ–‡ä»¶å
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        # æ‰“åŒ…buildåˆ†æ”¯æ‰€æœ‰å†…å®¹ï¼Œæ’é™¤.gitç›®å½•
        tar --exclude='.git' -czf build-package-$TIMESTAMP.tar.gz .
        echo "Package created: build-package-$TIMESTAMP.tar.gz"
        ls -la *.tar.gz

    - name: Create Git tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag ${{ needs.check-changes.outputs.next_tag }}
        git push origin ${{ needs.check-changes.outputs.next_tag }}
        echo "Tag ${{ needs.check-changes.outputs.next_tag }} created and pushed"

    - name: Generate release notes
      run: |
        TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
        {
          echo "è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬: ${{ needs.check-changes.outputs.next_tag }}"
          echo ""
          cat commit_history.txt
          echo ""
          cat contributors.txt
          echo ""
          echo "---"
          echo "æ„å»ºSHA: ${{ github.sha }}"
          echo "æ„å»ºæ—¶é—´: $TIMESTAMP"
        } > release_notes.md
        
        echo "Release notes:"
        cat release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.check-changes.outputs.next_tag }}
        name: Release ${{ needs.check-changes.outputs.next_tag }}
        body_path: release_notes.md
        files: build-package-*.tar.gz
        draft: false
        prerelease: false

  no-release-needed:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.has_changes == 'false' }}
    runs-on: ubuntu-latest
    steps:
    - name: Skip release
      run: |
        echo "ğŸš« æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œè·³è¿‡å‘å¸ƒRelease"
        echo "å½“å‰æœ€æ–°æ ‡ç­¾: $(git tag -l 'v1.0.*' --sort=-v:refname | head -n 1 || echo 'æ— ')"