name: Auto Release

permissions:
  contents: write

on:
  schedule:
    - cron: "0 12 * * 1" # ÊØèÂë®‰∏Ä 12:00 UTC
  workflow_dispatch:

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Ëé∑ÂèñÊúÄÊñ∞ tag
      - name: Get latest tag
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT

      # 3. ËÆ°ÁÆó‰∏ã‰∏Ä‰∏™ÁâàÊú¨Âè∑Ôºàpatch +1Ôºâ
      - name: Calculate next version
        id: next_version
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          version="${latest#v}"
          IFS='.' read -r major minor patch <<< "$version"
          patch=$((patch + 1))
          next="v$major.$minor.$patch"
          echo "next_version=$next" >> $GITHUB_OUTPUT

      # 4. ÁîüÊàê‰ºÅ‰∏öÁ∫ß Release Notes
      - name: Generate enterprise Release Notes
        id: release_notes
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          commits=$(git log $latest..HEAD --pretty=format:'%h|%an|%s' || echo "")
          authors=$(echo "$commits" | cut -d'|' -f2 | sort | uniq)
          total_commits=$(echo "$commits" | wc -l)

          feats=$(echo "$commits" | grep -i '^.*feat:' || true)
          fixes=$(echo "$commits" | grep -i '^.*fix:' || true)
          docs=$(echo "$commits" | grep -i '^.*docs:' || true)
          others=$(echo "$commits" | grep -v -E 'feat:|fix:|docs:' || true)

          date=$(date -u +"%Y-%m-%d")

          echo "## Êú¨Ê¨°Êõ¥Êñ∞ ${{ steps.next_version.outputs.next_version }} ($date)" > release_notes.md
          echo "" >> release_notes.md
          echo "ÂÖ± $total_commits Ê¨°Êèê‰∫§Ôºå$(echo "$authors" | wc -l) ‰ΩçË¥°ÁåÆËÄÖ" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ‚ú® Êñ∞ÂäüËÉΩ (feat)" >> release_notes.md
          echo "$feats" >> release_notes.md
          echo "" >> release_notes.md
          echo "### üêû ‰øÆÂ§ç (fix)" >> release_notes.md
          echo "$fixes" >> release_notes.md
          echo "" >> release_notes.md
          echo "### üìö ÊñáÊ°£ (docs)" >> release_notes.md
          echo "$docs" >> release_notes.md
          echo "" >> release_notes.md
          echo "### üîß ÂÖ∂‰ªñ" >> release_notes.md
          echo "$others" >> release_notes.md
          echo "" >> release_notes.md
          echo "Ë¥°ÁåÆËÄÖÔºö" >> release_notes.md
          echo "$authors" >> release_notes.md

      # 5. Êõ¥Êñ∞ CHANGELOG.md Âπ∂Êé®ÈÄÅ
      - name: Update CHANGELOG.md
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "# CHANGELOG" > CHANGELOG.md
          fi
          echo "" >> CHANGELOG.md
          cat release_notes.md >> CHANGELOG.md
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for ${{ steps.next_version.outputs.next_version }}" || echo "No changes to commit"
          git push origin HEAD:main

      # 6. Checkout build branch
      - name: Checkout build branch
        run: |
          git fetch origin build
          git checkout build

      # 7. Zip build artifacts
      - name: Zip build artifacts
        run: zip -r build-artifacts.zip ./*

      # 8. Create GitHub Release and upload ZIP
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.next_version.outputs.next_version }}
          name: "Release ${{ steps.next_version.outputs.next_version }}"
          body_path: release_notes.md
          files: build-artifacts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
