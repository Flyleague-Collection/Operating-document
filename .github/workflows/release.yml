name: Auto Release

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    # ÊØèÂ§© 16:00 UTC = ‰∏≠ÂõΩ CST Ê¨°Êó• 00:00ÔºàÂçàÂ§úÔºâ
    - cron: "0 16 * * *"
  workflow_dispatch:

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÂèëÂ∏É
      - name: Check if release should run
        id: check_release
        run: |
          DAY=$(date -u +%u) # 1=Mon ... 7=Sun (UTC weekday)
          echo "Today weekday: $DAY"

          # Âë®Êú´Ôºà6=Sat, 7=SunÔºâ‚Üí ÂøÖÂèëÂ∏É
          if [ "$DAY" -ge 6 ]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Âë®‰∏≠Ê£ÄÊü•ËøáÂéª 24h main ÊòØÂê¶ÊúâÊèê‰∫§
          COMMITS=$(git log origin/main --since="24 hours ago" --oneline)
          if [ -z "$COMMITS" ]; then
            echo "No commits in last 24h ‚Äî skip."
            echo "is_release=false" >> $GITHUB_OUTPUT
          else
            echo "Commits detected ‚Äî release will run."
            echo "is_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no release today
        if: steps.check_release.outputs.is_release == 'false'
        run: exit 0

      # Ëé∑ÂèñÊúÄÊñ∞ tag
      - name: Get latest tag
        id: get_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT

      # Ëá™Âä®ÈÄíÂ¢ûÁâàÊú¨Âè∑Ôºöpatch +1
      - name: Calculate next version
        id: next_version
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          version="${latest#v}"
          IFS='.' read -r major minor patch <<< "$version"
          next="v$major.$minor.$((patch + 1))"
          echo "next_version=$next" >> $GITHUB_OUTPUT
          echo "Next version: $next"

      # ÁîüÊàê Release Notes
      - name: Generate Release Notes
        run: |
          latest="${{ steps.get_tag.outputs.latest_tag }}"
          commits=$(git log $latest..HEAD --pretty=format:'%h|%an|%s' || true)
          authors=$(echo "$commits" | cut -d'|' -f2 | sort -u)
          total_commits=$(echo "$commits" | wc -l)

          feats=$(echo "$commits" | grep -i '^.*feat' || true)
          fixes=$(echo "$commits" | grep -i '^.*fix' || true)
          docs=$(echo "$commits" | grep -i '^.*docs' || true)
          others=$(echo "$commits" | grep -v -Ei 'feat|fix|docs' || true)

          date=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M CST")

          {
            echo "## üöÄ Release ${{ steps.next_version.outputs.next_version }} ($date)"
            echo ""
            echo "ÂÖ± **$total_commits** Ê¨°Êèê‰∫§ÔºåË¥°ÁåÆËÄÖ **$(echo "$authors" | wc -l)** ‰Ωç"
            echo ""
            echo "### ‚ú® Êñ∞ÂäüËÉΩ (feat)"
            echo "${feats:-Êó†}"
            echo ""
            echo "### üêû ‰øÆÂ§ç (fix)"
            echo "${fixes:-Êó†}"
            echo ""
            echo "### üìö ÊñáÊ°£ (docs)"
            echo "${docs:-Êó†}"
            echo ""
            echo "### üîß ÂÖ∂‰ªñ"
            echo "${others:-Êó†}"
            echo ""
            echo "üë• Ë¥°ÁåÆËÄÖÔºö"
            echo "$authors"
          } > release_notes.md

      # ‰∏ä‰º† Release Notes Áî®‰∫é‰∏ã‰∏Ä Job
      - uses: actions/upload-artifact@v4
        with:
          name: release_notes
          path: release_notes.md

  changelog-pr:
    needs: auto-release
    if: needs.auto-release.outputs.is_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: release_notes

      - name: Update CHANGELOG.md
        run: |
          [ ! -f CHANGELOG.md ] && echo "# CHANGELOG" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          cat release_notes.md >> CHANGELOG.md

          branch="chore/update-changelog-${{ github.run_id }}"
          git checkout -b "$branch"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for ${{ needs.auto-release.outputs.next_version }}"
          git push origin "$branch"

      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          title: "chore: update CHANGELOG for ${{ needs.auto-release.outputs.next_version }}"
          body: "Auto-update CHANGELOG"
          branch: "chore/update-changelog-${{ github.run_id }}"
          labels: documentation, automated

  release:
    needs: auto-release
    if: needs.auto-release.outputs.is_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build artifacts
        run: zip -r build-artifacts.zip ./*

      - uses: actions/download-artifact@v4
        with:
          name: release_notes

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.auto-release.outputs.next_version }}
          name: "Release ${{ needs.auto-release.outputs.next_version }}"
          body_path: release_notes.md
          files: build-artifacts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
