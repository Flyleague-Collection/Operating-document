name: Release Management

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¯æ—¥12ç‚¹è‡ªåŠ¨è§¦å‘
  schedule:
    - cron: '0 12 * * *'

permissions:
  contents: write  # æ·»åŠ å†™å…¥æƒé™

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œç”¨äºæ¯”è¾ƒå·®å¼‚
    
    - name: Get latest tag
      id: get_tag
      run: |
        # è·å–æœ€æ–°çš„tag
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        
        # å¦‚æœæ²¡æœ‰tagï¼Œè®¾ç½®ä¸ºåˆå§‹commit
        if [ -z "$LATEST_TAG" ]; then
          echo "first_commit=true" >> $GITHUB_OUTPUT
          echo "No previous tags found"
        else
          echo "first_commit=false" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"
        fi
    
    - name: Check differences (for scheduled runs)
      id: check_diff
      if: github.event_name == 'schedule'
      run: |
        # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡commitæˆ–è€…æ²¡æœ‰tagï¼Œç›´æ¥å‘å¸ƒ
        if [ "${{ steps.get_tag.outputs.first_commit }}" == "true" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "No previous tag found, will create first release"
          exit 0
        fi
        
        # æ£€æŸ¥å½“å‰mainåˆ†æ”¯ä¸æœ€æ–°tagä¹‹é—´çš„å·®å¼‚
        echo "Checking differences between ${{ steps.get_tag.outputs.latest_tag }} and HEAD"
        CHANGES=$(git diff ${{ steps.get_tag.outputs.latest_tag }} HEAD --name-only | wc -l)
        echo "Number of changed files: $CHANGES"
        
        if [ $CHANGES -gt 0 ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Found $CHANGES changed files since last tag ${{ steps.get_tag.outputs.latest_tag }}"
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes since last tag ${{ steps.get_tag.outputs.latest_tag }}"
        fi
    
    - name: Create Release (Auto - with changes)
      if: github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: auto-release-${{ github.run_id }}
        name: Auto Release ${{ github.run_number }}
        body: |
          ## è‡ªåŠ¨å‘å¸ƒ
          
          æœ¬æ¬¡å‘å¸ƒåŸºäºä»¥ä¸‹å˜æ›´ï¼š
          - ä¸ä¸Šä¸€ä¸ªæ ‡ç­¾ ${{ steps.get_tag.outputs.latest_tag }} çš„å·®å¼‚è§¦å‘å¸ƒ
          - å‘å¸ƒæ—¶é—´: ${{ fromJSON(format('"{0}"', toJSON(github.event.schedule))) }}
          
          å˜æ›´æ–‡ä»¶æ•°é‡ï¼š$(git diff ${{ steps.get_tag.outputs.latest_tag }} HEAD --name-only | wc -l)
        draft: false
        prerelease: false
    
    - name: Create Release (Manual)
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: manual-release-${{ github.run_id }}
        name: Manual Release ${{ github.run_number }}
        body: |
          ## æ‰‹åŠ¨å‘å¸ƒ
          
          æœ¬æ¬¡å‘å¸ƒç”±æ‰‹åŠ¨è§¦å‘æ‰§è¡Œã€‚
          - è§¦å‘è€…ï¼š${{ github.actor }}
          - å‘å¸ƒæ—¶é—´ï¼š${{ fromJSON(format('"{0}"', toJSON(github.event.head_commit.timestamp))) }}
        draft: false
        prerelease: false
    
    - name: Skip Release (No changes)
      if: github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'false'
      run: |
        echo "ğŸš« æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œè·³è¿‡å‘å¸ƒ"
        echo "ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼š${{ steps.get_tag.outputs.latest_tag }}"
        echo "å½“å‰åˆ†æ”¯ï¼š${{ github.ref }}"
        echo "å½“å‰commitï¼š$(git rev-parse HEAD)"