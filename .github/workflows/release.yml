name: Release Management

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"  # æ¯æ—¥ 12:00 UTCï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´ 20:00ï¼‰

permissions:
  contents: write

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch with tags and history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Get latest semantic tag
        id: get_tag
        shell: bash
        run: |
          LATEST_TAG=$(git tag --list "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          if [ -z "$LATEST_TAG" ]; then
            echo "first_commit=true" >> $GITHUB_OUTPUT
            echo "No semantic tag found; starting from v1.0.0"
          else
            echo "first_commit=false" >> $GITHUB_OUTPUT
            echo "Latest tag: $LATEST_TAG"
          fi

      - name: Compute next version
        id: version
        shell: bash
        run: |
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            NEXT_TAG="v1.0.0"
          else
            BASE=${{ steps.get_tag.outputs.latest_tag }}
            BASE=${BASE#v}
            MAJOR=$(echo $BASE | cut -d. -f1)
            MINOR=$(echo $BASE | cut -d. -f2)
            PATCH=$(echo $BASE | cut -d. -f3)
            NEXT_PATCH=$((PATCH + 1))
            NEXT_TAG="v${MAJOR}.${MINOR}.${NEXT_PATCH}"
          fi
          echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT
          echo "Next tag: $NEXT_TAG"

      - name: Detect changes for scheduled runs
        id: check_diff
        if: ${{ github.event_name == 'schedule' }}
        shell: bash
        run: |
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          CHANGES=$(git diff --name-only ${{ steps.get_tag.outputs.latest_tag }} HEAD | wc -l)
          echo "Changed files: $CHANGES"
          if [ $CHANGES -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout build branch for artifacts
        uses: actions/checkout@v4
        with:
          ref: build
          fetch-depth: 0

      - name: Generate build artifacts from build branch
        shell: bash
        run: |
          echo "ğŸ“¦ Generating build artifacts from build branch"
          # åˆ›å»ºæ„å»ºè¾“å‡ºç›®å½•
          mkdir -p build-output
          
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°æ„å»ºè¾“å‡ºç›®å½•ï¼ˆæ’é™¤build-outputè‡ªèº«ï¼‰
          find . -maxdepth 1 -mindepth 1 -not -name build-output -exec cp -r {} build-output/ \;
          
          # åˆ›å»ºæ„å»ºäº§ç‰©zipæ–‡ä»¶
          zip -r build-artifacts.zip build-output/
          
          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
          echo "Generated files:"
          ls -la build-artifacts.zip
          echo "âœ… Build artifacts generated successfully"

      - name: Collect commit info
        id: collect
        shell: bash
        run: |
          echo "ğŸ“ Collecting commit information..."
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
          else
            RANGE="${{ steps.get_tag.outputs.latest_tag }}..HEAD"
          fi
          
          # å¯¼å‡ºæœ¬æ¬¡å‘å¸ƒçš„commitä¿¡æ¯
          git log $RANGE --pretty=format:'%h: %s (%an)' > commits.txt
          COMMIT_COUNT=$(wc -l < commits.txt)
          echo "count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "Collected $COMMIT_COUNT commits"

      - name: Get contributors
        id: contrib
        shell: bash
        run: |
          echo "ğŸ‘¥ Collecting contributor information..."
          if [ "${{ steps.get_tag.outputs.first_commit }}" = "true" ]; then
            RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
          else
            RANGE="${{ steps.get_tag.outputs.latest_tag }}..HEAD"
          fi
          
          CONTRIB=$(git log $RANGE --pretty=format:'%an' 2>/dev/null | sort | uniq | grep -v '\[bot\]' | grep -v '^$' || true)
          if [ -z "$CONTRIB" ]; then
            CONTRIB="æ— "
          else
            CONTRIB=$(echo "$CONTRIB" | paste -sd ", " -)
          fi
          echo "contributors=$CONTRIB" >> $GITHUB_OUTPUT
          echo "Contributors: $CONTRIB"

      - name: Generate release notes
        id: notes
        shell: bash
        run: |
          echo "ğŸ“„ Generating release notes..."
          NEXT_TAG=${{ steps.version.outputs.next_tag }}
          
          cat << EOF > release_notes.md
          è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬: ${NEXT_TAG}
          
          å˜æ›´å†…å®¹:
          
          EOF
          
          # æ·»åŠ æäº¤è®°å½•
          if [ -f commits.txt ]; then
            cat commits.txt >> release_notes.md
          else
            echo "æ— æäº¤è®°å½•" >> release_notes.md
          fi
          
          cat << EOF >> release_notes.md
          
          è´¡çŒ®è€…:
          ${{ steps.contrib.outputs.contributors }}
          
          æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          echo "Generated release notes:"
          cat release_notes.md

      - name: Create Git Tag
        if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'true') }}
        shell: bash
        run: |
          git tag ${{ steps.version.outputs.next_tag }}
          git push origin ${{ steps.version.outputs.next_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Manual Release
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.next_tag }}
          name: Operating Document ${{ steps.version.outputs.next_tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            build-artifacts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Auto Release
        if: ${{ github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.next_tag }}
          name: Operating Document ${{ steps.version.outputs.next_tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            build-artifacts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip Release (No changes)
        if: ${{ github.event_name == 'schedule' && steps.check_diff.outputs.has_changes == 'false' }}
        shell: bash
        run: |
          echo "ğŸš« æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "å½“å‰æœ€æ–°ç‰ˆæœ¬: ${{ steps.get_tag.outputs.latest_tag }}"
          echo "æ²¡æœ‰æ–°çš„æäº¤éœ€è¦å‘å¸ƒ"

      - name: Cleanup
        if: always()
        shell: bash
        run: |
          echo "ğŸ§¹ Cleaning up temporary files..."
          rm -f commits.txt release_notes.md build-artifacts.zip
          echo "âœ… Cleanup completed"