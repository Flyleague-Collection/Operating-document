name: Auto Release

on:
  schedule:
    # 每天UTC时间12:00运行（对应北京时间20:00，请根据需求调整时区）
    - cron: '0 12 * * *'
  workflow_dispatch:  # 允许手动触发
    inputs:
      skip_check:
        description: '跳过变更检测直接发布'
        required: false
        default: false
        type: boolean

env:
  BUILD_BRANCH: 'build'  # 设置构建分支

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check-changes.outputs.has_changes }}
      next_tag: ${{ steps.get-next-tag.outputs.next_tag }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ env.BUILD_BRANCH }}
        fetch-depth: 0  # 获取所有历史记录，用于比较变更

    - name: Get next tag version
      id: get-next-tag
      run: |
        # 获取最新的v1.0.x标签
        LATEST_TAG=$(git tag -l "v1.0.*" --sort=-v:refname | head -n 1 || echo "")
        if [ -z "$LATEST_TAG" ]; then
          NEXT_TAG="v1.0.0"
        else
          # 递增版本号
          BASE_VERSION=$(echo $LATEST_TAG | cut -d. -f1-2)
          PATCH_VERSION=$(echo $LATEST_TAG | awk -F. '{print $3}')
          NEXT_PATCH=$((PATCH_VERSION + 1))
          NEXT_TAG="${BASE_VERSION}.${NEXT_PATCH}"
        fi
        echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT
        echo "Next tag: $NEXT_TAG"

    - name: Check for changes since last tag
      id: check-changes
      # 手动触发且选择跳过检测时，直接返回true
      if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_check) }}
      run: |
        LATEST_TAG=$(git tag -l "v1.0.*" --sort=-v:refname | head -n 1 || echo "")
        if [ -z "$LATEST_TAG" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "No existing tags, proceeding with release"
        else
          # 检查自上一个标签以来的变更[citation:1][citation:5]
          if git diff --name-only $LATEST_TAG HEAD | grep -q . ; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected since $LATEST_TAG"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected since $LATEST_TAG"
          fi
        fi

    - name: Force release for manual trigger
      # 手动触发且选择跳过检测时，强制设置为有变更
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.skip_check }}
      run: |
        echo "Manual trigger with skip check, forcing release"
        echo "has_changes=true" >> $GITHUB_OUTPUT

  create-release:
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 发布Release所需权限[citation:3]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ env.BUILD_BRANCH }}
        fetch-depth: 0

    - name: Get next tag and commit history
      id: get-info
      run: |
        NEXT_TAG="${{ needs.check-changes.outputs.next_tag }}"
        LATEST_TAG=$(git tag -l "v1.0.*" --sort=-v:refname | head -n 1 || echo "")
        
        # 获取提交历史
        if [ -z "$LATEST_TAG" ]; then
          COMMIT_RANGE="HEAD"
        else
          COMMIT_RANGE="$LATEST_TAG..HEAD"
        fi
        
        # 生成变更内容[citation:5]
        echo "变更内容:" > commit_history.txt
        git log $COMMIT_RANGE --pretty=format:"%h: %s" >> commit_history.txt
        
        # 获取去重后的贡献者列表
        echo "贡献者：" > contributors.txt
        git log $COMMIT_RANGE --pretty=format:"%an" | sort -u >> contributors.txt
        
        echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT

    - name: Create package
      run: |
        # 创建时间戳用于文件名
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        # 打包build分支所有内容
        tar -czf build-package-$TIMESTAMP.tar.gz .
        echo "timestamp=$TIMESTAMP" >> $GITHUB_ENV

    - name: Create Git tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag ${{ steps.get-info.outputs.next_tag }}
        git push origin ${{ steps.get-info.outputs.next_tag }}

    - name: Generate release notes
      id: generate-notes
      run: |
        {
          echo "自动发布版本: ${{ steps.get-info.outputs.next_tag }}"
          echo ""
          cat commit_history.txt
          echo ""
          cat contributors.txt
          echo ""
          echo "构建SHA: ${{ github.sha }}"
          echo "构建时间: $(date)"
        } > release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get-info.outputs.next_tag }}
        name: Release ${{ steps.get-info.outputs.next_tag }}
        body_path: release_notes.md
        files: build-package-${{ env.timestamp }}.tar.gz